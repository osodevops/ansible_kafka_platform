---
- name: Check if node keystore exists
  ansible.builtin.stat:
    path: "{{ kafka_ssl_dir }}/{{ inventory_hostname }}.keystore.p12"
  register: keystore_stat

- name: Create OpenSSL SAN config for node
  ansible.builtin.template:
    src: openssl-san.cnf.j2
    dest: "{{ kafka_ssl_dir }}/{{ inventory_hostname }}-san.cnf"
    owner: "{{ kafka_user }}"
    group: "{{ kafka_group }}"
    mode: "0600"
  when: not keystore_stat.stat.exists

- name: Generate node private key
  ansible.builtin.command: >
    openssl genrsa
    -out {{ kafka_ssl_dir }}/{{ inventory_hostname }}-key.pem 2048
  when: not keystore_stat.stat.exists
  no_log: true

- name: Generate CSR for node
  ansible.builtin.command: >
    openssl req -new
    -key {{ kafka_ssl_dir }}/{{ inventory_hostname }}-key.pem
    -out {{ kafka_ssl_dir }}/{{ inventory_hostname }}.csr
    -config {{ kafka_ssl_dir }}/{{ inventory_hostname }}-san.cnf
  when: not keystore_stat.stat.exists

- name: Sign node certificate with CA
  ansible.builtin.command: >
    openssl x509 -req
    -in {{ kafka_ssl_dir }}/{{ inventory_hostname }}.csr
    -CA {{ ssl_ca_cert }}
    -CAkey {{ ssl_ca_key }}
    -passin pass:{{ ssl_ca_password }}
    -CAcreateserial
    -out {{ kafka_ssl_dir }}/{{ inventory_hostname }}-cert.pem
    -days {{ ssl_cert_validity_days }}
    -extensions v3_req
    -extfile {{ kafka_ssl_dir }}/{{ inventory_hostname }}-san.cnf
  when: not keystore_stat.stat.exists
  no_log: true

- name: Create PKCS12 keystore
  ansible.builtin.command: >
    openssl pkcs12 -export
    -in {{ kafka_ssl_dir }}/{{ inventory_hostname }}-cert.pem
    -inkey {{ kafka_ssl_dir }}/{{ inventory_hostname }}-key.pem
    -chain -CAfile {{ ssl_ca_cert }}
    -name {{ inventory_hostname }}
    -out {{ kafka_ssl_dir }}/{{ inventory_hostname }}.keystore.p12
    -password pass:{{ ssl_keystore_password }}
  when: not keystore_stat.stat.exists
  no_log: true

- name: Set keystore permissions
  ansible.builtin.file:
    path: "{{ kafka_ssl_dir }}/{{ inventory_hostname }}.keystore.p12"
    owner: "{{ kafka_user }}"
    group: "{{ kafka_group }}"
    mode: "0400"

- name: Clean up intermediate files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ kafka_ssl_dir }}/{{ inventory_hostname }}.csr"
    - "{{ kafka_ssl_dir }}/{{ inventory_hostname }}-san.cnf"
